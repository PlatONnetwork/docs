<!doctype html>
<html lang="zh-CN" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.3">
<link rel="search" type="application/opensearchdescription+xml" title="PlatON" href="/docs/zh-CN/opensearch.xml">
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML"></script>
<script src="https://cdn.jsdelivr.net/npm/mermaid@8.4.0/dist/mermaid.min.js"></script>
<script src="/docs/js/custom.js"></script><title data-react-helmet="true">安全指南 | PlatON</title><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" property="og:url" content="https://luo-dahui.github.io//docs/zh-CN/Solidity_Contract_Security_Dev_Guide"><meta data-react-helmet="true" name="docsearch:language" content="zh-CN"><meta data-react-helmet="true" name="docsearch:version" content="current"><meta data-react-helmet="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-react-helmet="true" property="og:title" content="安全指南 | PlatON"><meta data-react-helmet="true" name="description" content="在Solidity合约中，可以来处理代币，甚至是更值钱的东西。此外，合约的每次执行都是公开的，源代码通常也是公开的。在区块链世界里，合约一直都是黑客的主要攻击点，同时也造成了非常大的损失。所以合约的安全开发非常重要，可以考虑从以下几个方面来提高合约的安全性。"><meta data-react-helmet="true" property="og:description" content="在Solidity合约中，可以来处理代币，甚至是更值钱的东西。此外，合约的每次执行都是公开的，源代码通常也是公开的。在区块链世界里，合约一直都是黑客的主要攻击点，同时也造成了非常大的损失。所以合约的安全开发非常重要，可以考虑从以下几个方面来提高合约的安全性。"><meta data-react-helmet="true" property="og:image" content="https://luo-dahui.github.io//docs/zh-CN/img/undraw_online.svg"><meta data-react-helmet="true" name="twitter:image" content="https://luo-dahui.github.io//docs/zh-CN/img/undraw_online.svg"><link data-react-helmet="true" rel="shortcut icon" href="/docs/zh-CN/img/logo.png"><link data-react-helmet="true" rel="canonical" href="https://luo-dahui.github.io//docs/zh-CN/Solidity_Contract_Security_Dev_Guide"><link data-react-helmet="true" rel="alternate" href="https://luo-dahui.github.io//docs/Solidity_Contract_Security_Dev_Guide" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://luo-dahui.github.io//docs/zh-CN/Solidity_Contract_Security_Dev_Guide" hreflang="zh-CN"><link data-react-helmet="true" rel="alternate" href="https://luo-dahui.github.io//docs/Solidity_Contract_Security_Dev_Guide" hreflang="x-default"><link data-react-helmet="true" rel="preconnect" href="https://BH4D9OD16A-dsn.algolia.net" crossorigin="anonymous"><link rel="stylesheet" href="/docs/zh-CN/assets/css/styles.9355613d.css">
<link rel="preload" href="/docs/zh-CN/assets/js/runtime~main.479eab5f.js" as="script">
<link rel="preload" href="/docs/zh-CN/assets/js/main.56d9618d.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div><a href="#" class="skipToContent_OuoZ">跳到主要内容</a></div><nav class="navbar navbar--fixed-top navbar--dark"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/docs/zh-CN/"><img src="/docs/zh-CN/img/PlatON-logo.svg" alt="PlatON" class="themedImage_TMUO themedImage--light_4Vu1 navbar__logo"><img src="/docs/zh-CN/img/PlatON-logo.svg" alt="PlatON" class="themedImage_TMUO themedImage--dark_uzRr navbar__logo"></a></div><div class="navbar__items navbar__items--right"><button type="button" class="DocSearch DocSearch-Button" aria-label="搜索"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">搜索</span></span><span class="DocSearch-Button-Keys"></span></button><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a href="#" class="navbar__item navbar__link"><span>中文</span></a><ul class="dropdown__menu"><li><a href="/docs/en/Solidity_Contract_Security_Dev_Guide" target="_self" rel="noopener noreferrer" class="dropdown__link" style="text-transform:capitalize">English</a></li><li><a href="/docs/zh-CN/Solidity_Contract_Security_Dev_Guide" target="_self" rel="noopener noreferrer" class="dropdown__link dropdown__link--active" style="text-transform:capitalize">中文</a></li></ul></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div><div class="navbar-sidebar"><div class="navbar-sidebar__brand"><a class="navbar__brand" href="/docs/zh-CN/"><img src="/docs/zh-CN/img/PlatON-logo.svg" alt="PlatON" class="themedImage_TMUO themedImage--light_4Vu1 navbar__logo"><img src="/docs/zh-CN/img/PlatON-logo.svg" alt="PlatON" class="themedImage_TMUO themedImage--dark_uzRr navbar__logo"></a></div><div class="navbar-sidebar__items"><div class="menu"><ul class="menu__list"><li class="menu__list-item menu__list-item--collapsed"><a href="#" role="button" class="menu__link menu__link--sublist"><span>Languages</span></a><ul class="menu__list"><li class="menu__list-item"><a href="/docs/en/Solidity_Contract_Security_Dev_Guide" target="_self" rel="noopener noreferrer" class="menu__link" style="text-transform:capitalize">English</a></li><li class="menu__list-item"><a href="/docs/zh-CN/Solidity_Contract_Security_Dev_Guide" target="_self" rel="noopener noreferrer" class="menu__link dropdown__link--active" style="text-transform:capitalize">中文</a></li></ul></li></ul></div></div></div></nav><div class="main-wrapper docs-wrapper doc-page"><div class="docPage_lDyR"><aside class="docSidebarContainer_0YBq"><div class="sidebar_a3j0"><nav class="menu menu--responsive thin-scrollbar menu_cyFh menuWithAnnouncementBar_+O1J" aria-label="Sidebar navigation"><button aria-label="打开菜单" aria-haspopup="true" class="button button--secondary button--sm menu__button" type="button"><svg class="sidebarMenuIcon_iZzd" width="24" height="24" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" href="/docs/zh-CN/">概述</a></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">初步了解</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/zh-CN/lat_introduced">什么是LAT</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/zh-CN/staking_and_delegation">质押&amp;委托</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/zh-CN/Network_Description">网络说明</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">进阶了解</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/zh-CN/PlatON_Overall_Solution">总体架构</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/zh-CN/Economic_Model">经济模型</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/zh-CN/PlatON_Solution">共识机制</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/zh-CN/PlatON_Governance_Solution">治理机制</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/zh-CN/Wasm_Operation_Principle">Wasm虚拟机</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">PlatON节点</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/zh-CN/PlatON_Validation_Introduce">验证节点介绍</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/zh-CN/Become_PlatON_Main_Verification">成为主网验证节点</a></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#" tabindex="-1">节点工具</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/zh-CN/OnLine_MTool_Manual">MTool在线教程</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/zh-CN/OffLine_MTool_Manual">MTool离线教程</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/zh-CN/Command_Line_Tools">命令行工具</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/zh-CN/CTool_Manual">CTool教程</a></li></ul></li></ul></li><li class="menu__list-item"><a class="menu__link menu__link--sublist menu__link--active" href="#">开发者</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/zh-CN/PlatON_Overview_DevGuide">开发指南</a></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#" tabindex="0">设置开发环境</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/zh-CN/Join_Dev_Network">开发网络</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/zh-CN/Build_Private_Chain">私有网络</a></li></ul></li><li class="menu__list-item"><a class="menu__link menu__link--sublist menu__link--active" href="#" tabindex="0">智能合约</a><ul class="menu__list"><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#" tabindex="0">系统合约</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/zh-CN/PlatON_system_contract">系统合约</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/zh-CN/PlatON_system_contract_api">系统合约接口说明</a></li></ul></li><li class="menu__list-item"><a class="menu__link menu__link--sublist menu__link--active" href="#" tabindex="0">Solidity合约</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/zh-CN/Solidity_Dev_Manual">入门手册</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/zh-CN/Solidity_Contract_Migrate">迁移教程</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/zh-CN/Solidity_Contract_Dev_Costs">开发成本</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/zh-CN/Solidity_Contract_Best_Practice">最佳实践</a></li><li class="menu__list-item"><a aria-current="page" class="menu__link menu__link--active active" tabindex="0" href="/docs/zh-CN/Solidity_Contract_Security_Dev_Guide">安全指南</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/zh-CN/Solidity_Inner_Contract">调用内置合约</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#" tabindex="0">Wasm合约</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/zh-CN/Wasm_Dev_Manual">入门手册</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/zh-CN/Wasm_Contract_Dev_Costs">开发成本</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/zh-CN/Wasm_Contract_Best_Practice">最佳实践</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/zh-CN/Wasm_Contract_API">合约API</a></li></ul></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#" tabindex="0">API参考</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/zh-CN/Python_SDK">Python SDK</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/zh-CN/JS_SDK">JS SDK</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/zh-CN/Java_SDK">Java SDK</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/zh-CN/Go_SDK">Go SDK</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/zh-CN/NET_SDK">.NET SDK</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/zh-CN/Json_Rpc">JSON RPC</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/zh-CN/GraphQL_Server">GraphQL Server</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/zh-CN/Explorer_API">Explorer API</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/zh-CN/Samurai_API">Samurai API</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#" tabindex="0">PRC Token</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/zh-CN/PRC20_contract">PRC-20</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/zh-CN/PRC721_contract">PRC-721</a></li></ul></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">数据分析</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/zh-CN/PlatON_BlockChain_Browser">PlatScan</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/zh-CN/PlatEye">PlatEye</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">示例教程</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/zh-CN/DApp_migrate">以太坊DApp快速迁移教程</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/zh-CN/qianqian_prc721_tutorial">PRC721NFT发行教程</a></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#" tabindex="-1">Wasm教程</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/zh-CN/WASM_Contract_1">WASM合约开发入门</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/zh-CN/WASM_Contract_2">WASM跨合约调用</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/zh-CN/WASM_Contract_3">WASM事件机制</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/zh-CN/WASM_Contract_4">WASM参数传递详解</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/zh-CN/WASM_Contract_5">WASM代理机制</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/zh-CN/WASM_Contract_6">WASM代理机制中访问合约事件</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/zh-CN/WASM_Contract_7">WASM通用代理</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/zh-CN/WASM_Contract_8">WASM内置数据结构</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/zh-CN/WASM_Contract_9">WASM内置数据结构性能测评</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#" tabindex="-1">WalletConnect</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/zh-CN/walletconnect_tutorial">WalletConnect</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/zh-CN/DApp_integration_with_WalletConnect_for_ATON">WalletConnect集成教程</a></li></ul></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/zh-CN/get_vrf_random_number">获取随机数教程</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/zh-CN/adapting_to_new_chainid">适配新链ID教程</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/zh-CN/eip55-bech32-compatible">EIP55和Bech32地址格式兼容方案</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">钱包</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/zh-CN/ATON-user-manual">ATON操作指南</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/zh-CN/Samurai_user_manual">Samurai</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/zh-CN/Third_Party_Walle">第三方钱包</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/zh-CN/Ledger-hardware-wallet">Ledger 硬件钱包</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/zh-CN/MetaMask">MetaMask</a></li></ul></li><li class="menu__list-item"><a class="menu__link" href="/docs/zh-CN/community">社区项目</a></li></ul></nav></div></aside><main class="docMainContainer_r8cw"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_zHA2"><div class="docItemContainer_oiyr"><article><div class="markdown"><header><h1 class="h1Heading_dC7a">安全指南</h1></header><p>在Solidity合约中，可以来处理代币，甚至是更值钱的东西。此外，合约的每次执行都是公开的，源代码通常也是公开的。在区块链世界里，合约一直都是黑客的主要攻击点，同时也造成了非常大的损失。所以合约的安全开发非常重要，可以考虑从以下几个方面来提高合约的安全性。</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="编译器bug"></a>编译器bug<a class="hash-link" href="#编译器bug" title="标题的直接链接">#</a></h3><p>首先必须了解Solidity编译器本身的bug，尽量规避有问题的编译器版本或者存在问题的使用方式。Solidity编译器bug列表：<a href="https://solidity.readthedocs.io/en/latest/bugs.html" target="_blank" rel="noopener noreferrer">https://solidity.readthedocs.io/en/latest/bugs.html</a> 。</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="标准合约开发流程"></a>标准合约开发流程<a class="hash-link" href="#标准合约开发流程" title="标题的直接链接">#</a></h3><p>如果想解决智能合约的安全问题，必须按照标准流程来开发合约。</p><ol><li>必须先完成详细的设计，充分考虑各种场景和异常情况。避免考虑不清楚，不全面引入的bug。</li><li>开发过程中，要做到模块化和简洁化，复杂性会增加出错的风险。</li><li>合约必须经过足够充分的review和测试才能发布到主网。</li><li>保持对合约运行状态的关注，紧急状态下可以销毁合约或者提供类似紧急冻结的功能。</li></ol><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="常见漏洞"></a>常见漏洞<a class="hash-link" href="#常见漏洞" title="标题的直接链接">#</a></h3><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="私有信息和随机性"></a>私有信息和随机性<a class="hash-link" href="#私有信息和随机性" title="标题的直接链接">#</a></h4><p>智能合约中使用的所有内容都是公开可见的，即使是标记了局部变量和状态变量 <code>private</code> 。</p><p>如果你不想让矿工作弊，那么在智能合约中使用随机数就相当困难（在智能合约中使用随机数很难保证节点不作弊， 这是因为智能合约中的随机数一般要依赖计算节点的本地时间得到， 而本地时间是可以被恶意节点伪造的，因此这种方法并不安全。 通行的做法是采用链外off-chain 的第三方服务，比如 Oraclize 来获取随机数）。</p><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="重入"></a>重入<a class="hash-link" href="#重入" title="标题的直接链接">#</a></h4><p>任何从合约 A 到合约 B 的交互以及任何从合约 A 到合约 B 的 以太币的转移。都会将控制权交给合约 B。这使得合约 B 能够在交互结束前回调 A 中的代码。举个例子，下面的代码包含一个bug（它只是一个片段，而不是一个完整的契约）：</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI javascript"><pre tabindex="0" class="prism-code language-javascript codeBlock_rtdJ thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#bfc7d5"><span class="token plain">pragma solidity </span><span class="token operator" style="color:rgb(137, 221, 255)">&gt;=</span><span class="token number" style="color:rgb(247, 140, 108)">0.4</span><span class="token number" style="color:rgb(247, 140, 108)">.0</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">&lt;</span><span class="token number" style="color:rgb(247, 140, 108)">0.7</span><span class="token number" style="color:rgb(247, 140, 108)">.0</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">// THIS CONTRACT CONTAINS A BUG - DO NOT USE</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">contract </span><span class="token maybe-class-name">Fund</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">/// Mapping of ether shares of the contract.</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token function" style="color:rgb(130, 170, 255)">mapping</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token parameter">address</span><span class="token plain"> </span><span class="token arrow operator" style="color:rgb(137, 221, 255)">=&gt;</span><span class="token plain"> uint</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> shares</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">/// Withdraw your share.</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token keyword" style="font-style:italic">function</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">withdraw</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">public</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token keyword control-flow" style="font-style:italic">if</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">msg</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token property-access">sender</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token method function property-access" style="color:rgb(130, 170, 255)">send</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">shares</span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token plain">msg</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token property-access">sender</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            shares</span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token plain">msg</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token property-access">sender</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">0</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span></span></code></pre><button type="button" aria-label="复制代码到剪贴板" class="copyButton_M3SB clean-btn">复制</button></div></div><p>这里的问题不是很严重，因为有限的 gas 也作为 <code>send</code> 的一部分，但仍然暴露了一个缺陷：以太币的传输过程中总是可以包含代码执行，所以接收者可以是一个回调进入 <code>withdraw</code> 的合约。 这就会使其多次得到退款，从而将合约中的全部以太币提取。 特别地，下面的合约将允许一个攻击者多次得到退款，因为它使用了 <code>call</code> ，默认发送所有剩余的 gas：</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI javascript"><pre tabindex="0" class="prism-code language-javascript codeBlock_rtdJ thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#bfc7d5"><span class="token plain">pragma solidity </span><span class="token operator" style="color:rgb(137, 221, 255)">&gt;=</span><span class="token number" style="color:rgb(247, 140, 108)">0.4</span><span class="token number" style="color:rgb(247, 140, 108)">.0</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">&lt;</span><span class="token number" style="color:rgb(247, 140, 108)">0.7</span><span class="token number" style="color:rgb(247, 140, 108)">.0</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">// THIS CONTRACT CONTAINS A BUG - DO NOT USE</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">contract </span><span class="token maybe-class-name">Fund</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">/// Mapping of ether shares of the contract.</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token function" style="color:rgb(130, 170, 255)">mapping</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token parameter">address</span><span class="token plain"> </span><span class="token arrow operator" style="color:rgb(137, 221, 255)">=&gt;</span><span class="token plain"> uint</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> shares</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">/// Withdraw your share.</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token keyword" style="font-style:italic">function</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">withdraw</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">public</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">bool success</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> msg</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token property-access">sender</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token property-access">call</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token method function property-access" style="color:rgb(130, 170, 255)">value</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">shares</span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token plain">msg</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token property-access">sender</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token string" style="color:rgb(195, 232, 141)">&quot;&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token keyword control-flow" style="font-style:italic">if</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">success</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            shares</span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token plain">msg</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token property-access">sender</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">0</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span></span></code></pre><button type="button" aria-label="复制代码到剪贴板" class="copyButton_M3SB clean-btn">复制</button></div></div><p>为了避免重入，你可以使用下面撰写的“检查-生效-交互”（Checks-Effects-Interactions）模式：</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI javascript"><pre tabindex="0" class="prism-code language-javascript codeBlock_rtdJ thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#bfc7d5"><span class="token plain">pragma solidity </span><span class="token operator" style="color:rgb(137, 221, 255)">&gt;=</span><span class="token number" style="color:rgb(247, 140, 108)">0.4</span><span class="token number" style="color:rgb(247, 140, 108)">.11</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">&lt;</span><span class="token number" style="color:rgb(247, 140, 108)">0.7</span><span class="token number" style="color:rgb(247, 140, 108)">.0</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">contract </span><span class="token maybe-class-name">Fund</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">/// Mapping of ether shares of the contract.</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token function" style="color:rgb(130, 170, 255)">mapping</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token parameter">address</span><span class="token plain"> </span><span class="token arrow operator" style="color:rgb(137, 221, 255)">=&gt;</span><span class="token plain"> uint</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> shares</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">/// Withdraw your share.</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token keyword" style="font-style:italic">function</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">withdraw</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">public</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        uint share </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> shares</span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token plain">msg</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token property-access">sender</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        shares</span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token plain">msg</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token property-access">sender</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">0</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        msg</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token property-access">sender</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token method function property-access" style="color:rgb(130, 170, 255)">transfer</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">share</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span></span></code></pre><button type="button" aria-label="复制代码到剪贴板" class="copyButton_M3SB clean-btn">复制</button></div></div><p>请注意重入不仅是以太币传输的其中一个影响，还包括任何对另一个合约的函数调用。 更进一步说，你也不得不考虑多合约的情况。 一个被调用的合约可以修改你所依赖的另一个合约的状态。</p><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="gas-限制和循环"></a>gas 限制和循环<a class="hash-link" href="#gas-限制和循环" title="标题的直接链接">#</a></h4><p>必须谨慎使用没有固定迭代次数的循环，例如依赖于存储 storage 值的循环：由于区块 gas 有限，交易只能消耗一定数量的 gas。无论是明确指出的还是正常运行过程中的，循环中的数次迭代操作所消耗的 gas 都有可能超出区块的 gas 限制，从而导致整个合约在某个时刻骤然停止。这可能不适用于只被用来从区块链中读取数据的 <code>view</code> 函数。 尽管如此，这些函数仍然可能会被其它合约当作链上on-chain操作的一部分来调用，并使那些操作骤然停止。 请在合约代码的说明文档中明确说明这些情况。</p><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="发送和接收以太币"></a>发送和接收以太币<a class="hash-link" href="#发送和接收以太币" title="标题的直接链接">#</a></h4><ul><li>目前无论是合约还是“外部账户”都不能阻止有人给它们发送 以太币Ether。 合约可以对一个正常的转账做出反应并拒绝它，但还有些方法可以不通过创建消息来发送 以太币Ether。 其中一种方法就是单纯地向合约地址“挖矿”，另一种方法就是使用 <code>selfdestruct(x)</code> 。</li><li>如果一个合约收到了以太币（且没有函数被调用），就会执行 fallback 函数。 如果没有 fallback 函数，那么以太币 Ether 会被拒收（同时会抛出异常）。 在 fallback 函数执行过程中，合约只能依靠此时可用的“gas 津贴”（2300 gas）来执行。 这笔津贴并不足以用来完成任何方式的存储 storage 访问。 为了确保你的合约可以通过这种方式收到 以太币，请你核对 fallback 函数所需的 gas 数量。</li><li>有一种方法可以通过使用 <code>addr.call.value(x)(&quot;&quot;)</code> 向接收合约发送更多的 gas。 这本质上跟 <code>addr.transfer(x)</code> 是一样的， 只不过前者发送所有剩余的 gas，并且使得接收者有能力执行更加昂贵的操作（它只会返回一个错误代码，而且也不会自动传播这个错误）。 这可能包括回调发送合约或者你想不到的其它状态改变的情况。因此这种方法无论是给诚实用户还是恶意行为者都提供了极大的灵活性。</li><li>尽可能地使用最精确的单位来表示wei的数量，因为您会丢失由于缺乏精确性而舍入的任何值。</li><li>如果你想要使用 <code>address.transfer</code>以太币，你需要注意以下几个细节：<ol><li>如果接收者是一个合约，它会执行自己的 fallback 函数，从而可以回调发送以太币的合约。</li><li>如果调用的深度超过 1024，发送以太币也会失败。由于调用者对调用深度有完全的控制权，他们可以强制使这次发送失败； 请考虑这种可能性，或者使用 <code>send</code> 并且确保每次都核对它的返回值。 更好的方法是使用一种接收者可以取回以太币的方式编写你的合约。</li><li>发送以太币也可能因为接收方合约的执行所需的 gas 多于分配的 gas 数量而失败（确切地说，是使用了 <code>require</code> ， <code>assert</code>， <code>revert</code> 或者因为这个操作过于昂贵） - “gas 不够用了”。 如果你使用 <code>transfer</code> 或者 <code>send</code> 的同时带有返回值检查，这就为接收者提供了在发送合约中阻断进程的方法。 再次说明，最佳实践是使用 <a href="https://solidity.readthedocs.io/en/latest/common-patterns.html#withdrawal-pattern" target="_blank" rel="noopener noreferrer">“取回”模式而不是“发送”模式</a>。</li></ol></li></ul><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="调用栈深度"></a>调用栈深度<a class="hash-link" href="#调用栈深度" title="标题的直接链接">#</a></h4><p>外部函数调用随时会失败，因为它们超过了调用栈的上限 1024。 在这种情况下，Solidity 会抛出一个异常。 恶意行为者也许能够在与你的合约交互之前强制将调用栈设置成一个比较高的值。</p><p>请注意，使用 <code>.send()</code> 时如果超出调用栈 <strong>并不会</strong> 抛出异常，而是会返回 <code>false</code>。 低级的函数比如 <code>.call()</code>，<code>.delegatecall()</code> 和 <code>.staticcall()</code> 也都是这样的。</p><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="txorigin"></a>tx.origin<a class="hash-link" href="#txorigin" title="标题的直接链接">#</a></h4><p>永远不要使用 tx.origin 做身份认证。假设你有一个如下的钱包合约：</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI javascript"><pre tabindex="0" class="prism-code language-javascript codeBlock_rtdJ thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#bfc7d5"><span class="token plain">pragma solidity </span><span class="token operator" style="color:rgb(137, 221, 255)">&gt;=</span><span class="token number" style="color:rgb(247, 140, 108)">0.5</span><span class="token number" style="color:rgb(247, 140, 108)">.0</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">&lt;</span><span class="token number" style="color:rgb(247, 140, 108)">0.7</span><span class="token number" style="color:rgb(247, 140, 108)">.0</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">// THIS CONTRACT CONTAINS A BUG - DO NOT USE</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">contract </span><span class="token maybe-class-name">TxUserWallet</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    address owner</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token function" style="color:rgb(130, 170, 255)">constructor</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">public</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        owner </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> msg</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token property-access">sender</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token keyword" style="font-style:italic">function</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">transferTo</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token parameter">address payable dest</span><span class="token parameter punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token parameter"> uint amount</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">public</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token function" style="color:rgb(130, 170, 255)">require</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">tx</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token property-access">origin</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">==</span><span class="token plain"> owner</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        dest</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token method function property-access" style="color:rgb(130, 170, 255)">transfer</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">amount</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span></span></code></pre><button type="button" aria-label="复制代码到剪贴板" class="copyButton_M3SB clean-btn">复制</button></div></div><p>现在有人欺骗你，将以太币发送到了这个恶意钱包的地址：</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI javascript"><pre tabindex="0" class="prism-code language-javascript codeBlock_rtdJ thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#bfc7d5"><span class="token plain">pragma solidity </span><span class="token operator" style="color:rgb(137, 221, 255)">&gt;=</span><span class="token number" style="color:rgb(247, 140, 108)">0.5</span><span class="token number" style="color:rgb(247, 140, 108)">.0</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">&lt;</span><span class="token number" style="color:rgb(247, 140, 108)">0.7</span><span class="token number" style="color:rgb(247, 140, 108)">.0</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">interface</span><span class="token plain"> </span><span class="token class-name" style="color:rgb(255, 203, 107)">TxUserWallet</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token keyword" style="font-style:italic">function</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">transferTo</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token parameter">address payable dest</span><span class="token parameter punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token parameter"> uint amount</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> external</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">contract </span><span class="token maybe-class-name">TxAttackWallet</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    address payable owner</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token function" style="color:rgb(130, 170, 255)">constructor</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">public</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        owner </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> msg</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token property-access">sender</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token keyword" style="font-style:italic">function</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> external </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token function maybe-class-name" style="color:rgb(130, 170, 255)">TxUserWallet</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">msg</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token property-access">sender</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token method function property-access" style="color:rgb(130, 170, 255)">transferTo</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">owner</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> msg</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token property-access">sender</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token property-access">balance</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span></span></code></pre><button type="button" aria-label="复制代码到剪贴板" class="copyButton_M3SB clean-btn">复制</button></div></div><p>如果你的钱包检查过 <code>msg.sender</code> 为了获得授权，它将获取攻击钱包的地址，而不是所有者地址。但是通过检查 <code>tx.origin</code> ，它获取启动事务的原始地址，该地址仍然是所有者地址。攻击钱包会立即耗尽你所有的资金。</p><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="二的补码下溢上溢"></a>二的补码/下溢/上溢<a class="hash-link" href="#二的补码下溢上溢" title="标题的直接链接">#</a></h4><p>与许多编程语言一样，solidity的整数类型实际上不是整数。当值很小时，它们类似于整数，但如果数值较大，则表现不同。例如，以下是正确的： <code>uint8(255) + uint8(1) == 0</code> .这种情况被称为上溢。当执行的操作需要固定大小的变量来存储超出变量数据类型范围的数值（或数据块）时，就会发生这种情况。一个下溢的情况是： <code>uint8(0) - uint8(1) == 255</code> .</p><p>一般来说，阅读关于二的补码表示的限制，它甚至对有符号数有一些更特殊的边界情况。</p><p>尝试使用 <code>require</code> 将输入的大小限制在合理的范围内，并使用 <a href="https://solidity.readthedocs.io/en/latest/layout-of-source-files.html#smt-checker" target="_blank" rel="noopener noreferrer">SMT checker</a> 查找潜在的溢出，或使用类似的库 <a href="https://github.com/OpenZeppelin/openzeppelin-contracts/blob/master/contracts/math/SafeMath.sol" target="_blank" rel="noopener noreferrer">SafeMath</a> ，如果希望所有溢出都能还原。</p><p>代码 <code>require((balanceOf[_to] + _value) &gt;= balanceOf[_to])</code> 还可以检查值是否符合期望。</p><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="清理mappings"></a>清理Mappings<a class="hash-link" href="#清理mappings" title="标题的直接链接">#</a></h4><p>Solidity <code>mapping</code> 类型(参考 <a href="https://solidity.readthedocs.io/en/latest/types.html#mapping-types" target="_blank" rel="noopener noreferrer">Mapping Types</a>) 是仅存储键值的数据结构，不会跟踪分配了非零值的键索引。因此，在没有键索引信息的情况下，无法清除<code>mapping</code>。如果将<code>mapping</code>用作动态存储数组的基本类型，则删除或弹出该数组将不会对<code>mapping</code>元素产生影响。例如，如果将<code>mapping</code>用作 struct 的成员字段的类型，同时struct作为动态存储数组的基本类型，则会发生相同的情况。在包含<code>mapping</code>的结构或数组的分配中，也将忽略<code>mapping</code>。</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI javascript"><pre tabindex="0" class="prism-code language-javascript codeBlock_rtdJ thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#bfc7d5"><span class="token plain">pragma solidity </span><span class="token operator" style="color:rgb(137, 221, 255)">&gt;=</span><span class="token number" style="color:rgb(247, 140, 108)">0.5</span><span class="token number" style="color:rgb(247, 140, 108)">.0</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">&lt;</span><span class="token number" style="color:rgb(247, 140, 108)">0.7</span><span class="token number" style="color:rgb(247, 140, 108)">.0</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">contract </span><span class="token known-class-name class-name" style="color:rgb(255, 203, 107)">Map</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token function" style="color:rgb(130, 170, 255)">mapping</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token parameter">uint</span><span class="token plain"> </span><span class="token arrow operator" style="color:rgb(137, 221, 255)">=&gt;</span><span class="token plain"> uint</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token plain"> array</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token keyword" style="font-style:italic">function</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">allocate</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token parameter">uint _newMaps</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">public</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token keyword control-flow" style="font-style:italic">for</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">uint i </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">0</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"> i </span><span class="token operator" style="color:rgb(137, 221, 255)">&lt;</span><span class="token plain"> _newMaps</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"> i</span><span class="token operator" style="color:rgb(137, 221, 255)">++</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            array</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token method function property-access" style="color:rgb(130, 170, 255)">push</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token keyword" style="font-style:italic">function</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">writeMap</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token parameter">uint _map</span><span class="token parameter punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token parameter"> uint _key</span><span class="token parameter punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token parameter"> uint _value</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">public</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        array</span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token plain">_map</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token plain">_key</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> _value</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token keyword" style="font-style:italic">function</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">readMap</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token parameter">uint _map</span><span class="token parameter punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token parameter"> uint _key</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">public</span><span class="token plain"> view </span><span class="token function" style="color:rgb(130, 170, 255)">returns</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token parameter">uint</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token keyword control-flow" style="font-style:italic">return</span><span class="token plain"> array</span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token plain">_map</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token plain">_key</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token keyword" style="font-style:italic">function</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">eraseMaps</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">public</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token keyword" style="font-style:italic">delete</span><span class="token plain"> array</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span></span></code></pre><button type="button" aria-label="复制代码到剪贴板" class="copyButton_M3SB clean-btn">复制</button></div></div><p>考虑上面的示例和以下调用顺序: <code>allocate(10)</code>, <code>writeMap(4, 128, 256)</code>. 此时, 调用 <code>readMap(4, 128)</code> 返回256。如果调用 <code>eraseMaps</code>，状态变量 <code>array</code> 的长度是0, 但它的 <code>mapping</code> 元素没有清零, 它们的信息仍然存储在合约的存储区。删除数组之后, 调用 <code>allocate(5)</code> 允许我们再次访问 <code>array[4]</code> , 此时即使不调用 <code>writeMap</code>，当调用 <code>readMap(4, 128)</code> 仍然会返回256。</p><p>如果必须删除<code>mapping</code>信息, 可以考虑使用类似 <a href="https://github.com/ethereum/dapp-bin/blob/master/library/iterable_mapping.sol" target="_blank" rel="noopener noreferrer">iterable mapping</a>库，从而允许遍历键并在适当的<code>mapping</code>中删除其值。</p><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="权限控制错误"></a>权限控制错误<a class="hash-link" href="#权限控制错误" title="标题的直接链接">#</a></h4><p>在智能合约中，合约开发者一般都会设置一些用于合约所有者，但如果开发者疏忽写错了函数权限，就有可能导致所有者转移等严重后果。</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI javascript"><pre tabindex="0" class="prism-code language-javascript codeBlock_rtdJ thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#bfc7d5"><span class="token keyword" style="font-style:italic">function</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">initContract</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">public</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    owner </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> msg</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token property-access">reader</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span></span></code></pre><button type="button" aria-label="复制代码到剪贴板" class="copyButton_M3SB clean-btn">复制</button></div></div><p>上述代码函数就需要设置onlyOwner。</p><p>合约中不同函数应设置合理的权限。</p><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="地址初始化问题"></a>地址初始化问题<a class="hash-link" href="#地址初始化问题" title="标题的直接链接">#</a></h4><p>在EVM中，所有与地址有关的初始化时，都会赋予初值0。</p><p>如果一个address变量与0相等时，说明该变量可能未初始化或出现了未知的错误。</p><p>如果开发者在代码中初始化了某个address变量，但未赋予初值，或用户在发起某种操作时，误操作未赋予address变量，但在下面的代码中需要对这个变量做处理，就可能导致不必要的安全风险。</p><p>涉及到地址的函数中，建议加入require(_to!=address(0))验证，有效避免用户误操作或未知错误导致的不必要的损失。</p><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="交易顺序依赖"></a>交易顺序依赖<a class="hash-link" href="#交易顺序依赖" title="标题的直接链接">#</a></h4><p>由于交易在短暂的时间内会先存放到mempool中，所以在矿工将其打包进block之前，是可以知道会发生什么动作的。这对于一个去中心化的市场来说是麻烦的，因为可以查看到代币的交易信息，并且可以在它被打包进block之前改变交易顺序。避免这一点很困难，因为它归结为具体的合同本身。</p><p>例如，在市场上，最好实施批量拍卖（这也可以防止高频交易问题）。另一种使用预提交方案的方法。</p><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="其他"></a>其他<a class="hash-link" href="#其他" title="标题的直接链接">#</a></h4><p>不占满32个字节的类型可能包含“脏的高阶位”。如果访问 <code>msg.data</code> ，这尤其重要-这会造成延展性风险：那么可以设计使用原始字节参数0xff000001和0x00000001调用函数 f(uint8 x) 的交易。两者都输入了合约，就x而言，两者看起来都像数字1，但是msg.data会有所不同，因此，如果对任何内容使用keccak256(msg.data)，将获得不同的结果。</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="安全建议"></a>安全建议<a class="hash-link" href="#安全建议" title="标题的直接链接">#</a></h3><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="认真对待警告"></a>认真对待警告<a class="hash-link" href="#认真对待警告" title="标题的直接链接">#</a></h4><p>如果编译器警告了你什么事，你最好修改一下，即使你不认为这个特定的警告不会产生安全隐患，因为那也有可能埋藏着其他的问题。 我们给出的任何编译器警告，都可以通过轻微的修改来去掉。</p><p>始终使用最新版本的编译器来通知所有最近引入的警告。</p><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="限定以太币的数量"></a>限定以太币的数量<a class="hash-link" href="#限定以太币的数量" title="标题的直接链接">#</a></h4><p>限定存储storage 在一个智能合约中以太币（或者其它tokens）的数量。 如果你的源代码、编译器或者平台出现了 bug，可能会导致这些资产丢失。 如果你想控制你的损失，就要限定以太币的数量。</p><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="保持合约简练且模块化"></a>保持合约简练且模块化<a class="hash-link" href="#保持合约简练且模块化" title="标题的直接链接">#</a></h4><p>保持你的合约短小精炼且易于理解。找出无关于其它合约或库的功能。 有关源码质量可以采用的一般建议： 限制局部变量的数量以及函数的长度等等。 将实现的函数文档化，这样别人看到代码的时候就可以理解你的意图，并判断代码是否按照正确的意图实现。</p><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="使用检查-生效-交互checks-effects-interactions模式"></a>使用“检查-生效-交互”（Checks-Effects-Interactions）模式<a class="hash-link" href="#使用检查-生效-交互checks-effects-interactions模式" title="标题的直接链接">#</a></h4><p>大多数函数会首先做一些检查工作（例如谁调用了函数，参数是否在取值范围之内，它们是否发送了足够的以太币，用户是否具有tokens等等）。这些检查工作应该首先被完成。</p><p>第二步，如果所有检查都通过了，应该接着进行会影响当前合约状态变量的那些处理。 与其它合约的交互应该是任何函数的最后一步。</p><p>早期合约延迟了一些效果的产生，为了等待外部函数调用以非错误状态返回。 由于上文所述的重入问题，这通常会导致严重的后果。</p><p>请注意，对已知合约的调用反过来也可能导致对未知合约的调用，所以最好是一直保持使用这个模式编写代码。</p><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="包含故障-安全fail-safe模式"></a>包含故障-安全（Fail-Safe）模式<a class="hash-link" href="#包含故障-安全fail-safe模式" title="标题的直接链接">#</a></h4><p>尽管将系统完全去中心化可以省去许多中间环节，但包含某种故障-安全模式仍然是好的做法，尤其是对于新的代码来说：</p><p>你可以在你的智能合约中增加一个函数实现某种程度上的自检查，比如“ 以太币是否会泄露？”， “通证的总和是否与合约的余额相等？”等等。 请记住，你不能使用太多的 gas，所以可能需要通过链外off-chain 计算来辅助。</p><p>如果自检查没有通过，合约就会自动切换到某种“故障安全”模式， 例如，关闭大部分功能，将控制权交给某个固定的可信第三方，或者将合约转换成一个简单的“退回我的钱”合约。</p><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="认真检查函数权限"></a>认真检查函数权限<a class="hash-link" href="#认真检查函数权限" title="标题的直接链接">#</a></h4><p>合约中不同函数应设置合理的权限。</p><p>检查合约中各函数是否正确使用了public、private等关键词进行可见性修饰，检查合约是否正确定义并使用了modifier对关键函数进行访问限制，避免越权导致的问题。</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI javascript"><pre tabindex="0" class="prism-code language-javascript codeBlock_rtdJ thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#bfc7d5"><span class="token keyword" style="font-style:italic">function</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">initContract</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">public</span><span class="token plain"> </span><span class="token maybe-class-name">OnlyOwner</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    owner </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> msg</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token property-access">reader</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span></span></code></pre><button type="button" aria-label="复制代码到剪贴板" class="copyButton_M3SB clean-btn">复制</button></div></div><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="要求同行评审"></a>要求同行评审<a class="hash-link" href="#要求同行评审" title="标题的直接链接">#</a></h4><p>检查一段代码的人越多，发现的问题就越多。让检查者检查您的代码也有助于交叉检查您的代码是否易于理解——这是良好智能合约的一个非常重要的标准。</p><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="其他-1"></a>其他<a class="hash-link" href="#其他-1" title="标题的直接链接">#</a></h4><ol><li><a href="https://github.com/guylando/KnowledgeLists/blob/master/EthereumSmartContracts.md" target="_blank" rel="noopener noreferrer">更多安全建议</a></li><li><a href="https://consensys.github.io/smart-contract-best-practices/" target="_blank" rel="noopener noreferrer">合约最佳实践</a></li></ol><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="安全工具"></a>安全工具<a class="hash-link" href="#安全工具" title="标题的直接链接">#</a></h3><ol><li>以太坊形式化验证工具 <a href="https://solidity.readthedocs.io/en/latest/layout-of-source-files.html#smt-checker" target="_blank" rel="noopener noreferrer">SMT checker</a>。</li><li>形式化验证工具：提供<a href="https://marketplace.visualstudio.com/items?itemName=Beosin.beosin-vaas-eth" target="_blank" rel="noopener noreferrer">离线VS Code插件</a>，和<a href="https://beosin.com/vaas/index.html#/audit/ptsj" target="_blank" rel="noopener noreferrer">在线版</a>。</li><li>使用remix集成的安全扫描插件<a href="https://docs.mythx.io/en/latest/" target="_blank" rel="noopener noreferrer">MythX</a>。</li></ol><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="第三方审计"></a>第三方审计<a class="hash-link" href="#第三方审计" title="标题的直接链接">#</a></h3><p>可以找专业的第三方审计公司进行安全审计如：<a href="https://www.slowmist.com/service-smart-contract-security-audit.html" target="_blank" rel="noopener noreferrer">慢雾</a>。</p><hr></div><footer class="row docusaurus-mt-lg"><div class="col"><a href="https://github.com/PlatONnetwork/docs/tree/master/website/i18n/zh-CN/docusaurus-plugin-content-docs/current/solidity合约安全开发指南.md" target="_blank" rel="noreferrer noopener"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_mS5F" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>编辑此页</a></div><div class="col lastUpdated_wj+Z"></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="文档分页导航"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/docs/zh-CN/Solidity_Contract_Best_Practice"><div class="pagination-nav__sublabel">上一页</div><div class="pagination-nav__label">« 最佳实践</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/docs/zh-CN/Solidity_Inner_Contract"><div class="pagination-nav__sublabel">下一页</div><div class="pagination-nav__label">调用内置合约 »</div></a></div></nav></div></div><div class="col col--3"><div class="tableOfContents_vrFS thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#编译器bug" class="table-of-contents__link">编译器bug</a></li><li><a href="#标准合约开发流程" class="table-of-contents__link">标准合约开发流程</a></li><li><a href="#常见漏洞" class="table-of-contents__link">常见漏洞</a></li><li><a href="#安全建议" class="table-of-contents__link">安全建议</a></li><li><a href="#安全工具" class="table-of-contents__link">安全工具</a></li><li><a href="#第三方审计" class="table-of-contents__link">第三方审计</a></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container"><div class="row footer__links"><div class="col footer__col"><ul class="footer__items"><li class="footer__item"><a href="https://www.platon.network/" target="_blank" class="footer-logo-home" rel="noreferrer noopener"><img src="/docs/zh-CN/img/PlatON-logo2.svg" width="66" height="58"></a></li></ul></div><div class="col footer__col"><ul class="footer__items"><li class="footer__item"><a href="https://www.platon.network/" target="_blank" rel="noopener noreferrer" class="footer__link-item" hrefzh="https://www.platon.network/">PlatON network</a></li><li class="footer__item"><a href="https://latticex.foundation/home" target="_blank" rel="noopener noreferrer" class="footer__link-item" hrefzh="https://latticex.foundation/home">LatticeX.Foundation</a></li><li class="footer__item"><a href="https://forum.latticex.foundation/" target="_blank" rel="noopener noreferrer" class="footer__link-item" hrefzh="https://forum.latticex.foundation/">Forum</a></li></ul></div><div class="gitstar"><a class="github-button" href="https://github.com/PlatONnetwork/PlatON-Go" data-color-scheme="no-preference: light; light: light; dark: light;" data-icon="octicon-star" data-size="small" data-show-count="true" aria-label="Star PlatONnetwork/PlatON-Go on GitHub">Star</a></div></div><div class="footer__bottom text--center"><div class="footer__copyright">COPYRIGHT  © 2022 PLATON NETWORK.</div></div></div></footer></div>
<script src="/docs/zh-CN/assets/js/runtime~main.479eab5f.js"></script>
<script src="/docs/zh-CN/assets/js/main.56d9618d.js"></script>
</body>
</html>